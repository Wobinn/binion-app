<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>Binion Scrapbook</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        :root {
            --font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            
            /* ÎùºÏù¥Ìä∏ Î™®Îìú */
            --bg-image: radial-gradient(circle at 50% 0%, rgba(124, 111, 216, 0.12) 0%, transparent 70%), linear-gradient(180deg, #fcfdff 0%, #f3f4f6 100%);
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 10px 30px rgba(0, 0, 0, 0.06), 0 4px 6px rgba(0, 0, 0, 0.02), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            --glass-blur: blur(15px) saturate(120%);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-color: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1, #818cf8);
            --folder-color: #818cf8;
            --logo-gradient: linear-gradient(to right, #6366f1, #a5b4fc);
            --toggle-bg: rgba(200, 200, 200, 0.2);
            --toggle-indicator: #ffffff;
            --sync-color: #d1d5db;
            --sync-active: #6366f1;
            --dropdown-hover: rgba(99, 102, 241, 0.08);
        }

        [data-theme="dark"] {
            /* Îã§ÌÅ¨ Î™®Îìú */
            --bg-image: radial-gradient(circle at 50% -20%, rgba(99, 102, 241, 0.15) 0%, transparent 60%), linear-gradient(180deg, #0f1117 0%, #050505 100%);
            --glass-bg: rgba(20, 22, 30, 0.7); 
            --glass-border: rgba(255, 255, 255, 0.1); 
            --glass-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), 0 8px 16px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            --glass-blur: blur(20px) saturate(140%);
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --accent-color: #818cf8;
            --accent-gradient: linear-gradient(135deg, #818cf8, #6366f1);
            --folder-color: #6366f1;
            --logo-gradient: linear-gradient(to right, #818cf8, #c7d2fe);
            --toggle-bg: rgba(255, 255, 255, 0.1);
            --toggle-indicator: #818cf8;
            --sync-color: #374151;
            --sync-active: #818cf8;
            --dropdown-hover: rgba(255, 255, 255, 0.1);
        }

        /* Í≥µÌÜµ Ïä§ÌÉÄÏùº */
        .glass-panel {
            background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 24px;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s, background 0.3s;
        }
        body { margin: 0; background-image: var(--bg-image); background-attachment: fixed; background-size: cover; color: var(--text-primary); font-family: var(--font-family); transition: background 0.5s ease, color 0.5s ease; padding-bottom: 100px; line-height: 1.6; min-height: 100vh; }
        .container { max-width: 860px; margin: 0 auto; padding: 40px 25px; }
        .header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 40px; gap: 15px; }
        .logo { font-size: 38px; font-weight: 800; background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; letter-spacing: -1.5px; }

        /* Î≤ÑÌäº Í∑∏Î£π (ÎèôÍ∏∞Ìôî, ÏÑ§Ï†ï, ÌÖåÎßà) */
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .icon-btn {
            background: var(--toggle-bg); border: 1px solid var(--glass-border); border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-primary); transition: all 0.2s;
        }
        .icon-btn:hover { background: var(--glass-bg); transform: scale(1.1); }
        
        .theme-toggle-btn {
            background: var(--toggle-bg); border: 1px solid var(--glass-border); border-radius: 30px; cursor: pointer;
            display: flex; align-items: center; padding: 4px; position: relative; width: 64px; height: 34px; backdrop-filter: blur(5px);
        }
        .toggle-indicator {
            width: 24px; height: 24px; border-radius: 50%; background: var(--toggle-indicator);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: absolute; left: 4px;
        }
        body[data-theme="dark"] .toggle-indicator { transform: translateX(30px); }
        
        /* Í≤ÄÏÉâÏ∞Ω */
        .search-box-container { margin-bottom: 40px; display: flex; justify-content: center; }
        .search-box {
            display: flex; align-items: center; width: 100%; max-width: 550px; padding: 12px 24px; border-radius: 40px;
            background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); transition: all 0.3s;
        }
        .search-box:focus-within { border-color: var(--accent-color); transform: translateY(-2px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .search-box input { border: none; background: transparent; padding: 4px; font-size: 16px; flex: 1; outline: none; color: var(--text-primary); font-family: var(--font-family); }
        .search-icon { color: var(--text-secondary); font-size: 24px; opacity: 0.7; margin-left: 10px; display: flex; align-items: center; }

        .tabs { display: flex; gap: 12px; margin-bottom: 40px; justify-content: center; }
        .tab-btn { background: transparent; border: 1px solid transparent; padding: 10px 24px; border-radius: 30px; color: var(--text-secondary); cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.3s; }
        .tab-btn.active { background: var(--accent-gradient); color: #ffffff; box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); }

        /* ÏûÖÎ†• Ïπ¥Îìú */
        .input-card { padding: 35px; margin-bottom: 50px; display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 50; }
        .input-row { display: flex; gap: 12px; align-items: center; }
        
        /* Ïª§Ïä§ÌÖÄ ÎìúÎ°≠Îã§Ïö¥ */
        .custom-select-wrapper { position: relative; width: 35%; min-width: 100px; font-family: var(--font-family); }
        .custom-select-trigger {
            display: flex; justify-content: space-between; align-items: center; padding: 16px 20px;
            border: 1px solid var(--glass-border); border-radius: 16px; font-size: 15px; background: rgba(0, 0, 0, 0.03); color: var(--text-primary); cursor: pointer; transition: all 0.3s; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .custom-select-trigger { background: rgba(255, 255, 255, 0.05); }
        .custom-options {
            position: absolute; top: 110%; left: 0; right: 0; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s; z-index: 100; overflow: hidden;
        }
        .custom-options.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 12px 20px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.2s; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .custom-option:hover { background: var(--dropdown-hover); color: var(--accent-color); padding-left: 25px; }
        .custom-option.selected { background: var(--accent-gradient); color: white; }

        input[type="text"] {
            padding: 16px 20px; border: 1px solid var(--glass-border); border-radius: 16px; font-size: 15px; font-family: var(--font-family); box-sizing: border-box; transition: all 0.3s; background: rgba(0, 0, 0, 0.03); color: var(--text-primary); flex: 1;
        }
        [data-theme="dark"] input[type="text"] { background: rgba(255, 255, 255, 0.05); }
        input:focus { outline: none; border-color: var(--accent-color); background: transparent; }
        
        .btn-ai {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); color: #fff; border: none; width: 54px; height: 54px; border-radius: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 4px 15px rgba(142, 197, 252, 0.4);
        }
        .btn-ai:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(142, 197, 252, 0.6); }
        .btn-ai.loading { animation: pulse-ai 1.5s infinite; opacity: 0.8; pointer-events: none; }
        @keyframes pulse-ai { 0% { transform: scale(0.95); } 50% { transform: scale(1.05); } 100% { transform: scale(0.95); } }

        .btn-add {
            background: var(--accent-gradient); color: white; border: none; padding: 18px; border-radius: 16px; font-weight: 700; cursor: pointer; font-size: 16px; margin-top: 10px; transition: all 0.3s; box-shadow: 0 8px 20px rgba(99, 102, 241, 0.25);
        }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(99, 102, 241, 0.4); }

        /* Î¶¨Ïä§Ìä∏ Ïä§ÌÉÄÏùº */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; margin-top: 30px; }
        .folder-item { padding: 30px 20px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .folder-icon { font-size: 48px; color: var(--folder-color); margin-bottom: 15px; opacity: 0.9; }
        .folder-name { font-size: 15px; font-weight: 700; }
        .folder-count { font-size: 12px; color: var(--text-secondary); margin-top: 5px; opacity: 0.8; }
        .scrap-list { display: flex; flex-direction: column; gap: 20px; }
        .card { padding: 25px; display: flex; flex-direction: column; gap: 12px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .category-badge { font-size: 11px; padding: 6px 10px; border-radius: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .cat-ai { background: rgba(99, 102, 241, 0.1); color: #6366f1; }
        .cat-startup { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .cat-info { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .cat-daily { background: rgba(236, 72, 153, 0.1); color: #ec4899; }
        .cat-etc { background: rgba(107, 114, 128, 0.1); color: #6b7280; }
        .card-date { font-size: 13px; color: var(--text-secondary); }
        .card-memo { font-size: 17px; font-weight: 700; line-height: 1.4; color: var(--text-primary); }
        .card-url { font-size: 14px; color: var(--accent-color); text-decoration: none; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.9; transition: opacity 0.2s; }
        .card-url:hover { opacity: 1; text-decoration: underline; }
        .btn-back { display: inline-flex; align-items: center; gap: 8px; background: transparent; border: none; padding: 10px 0; color: var(--text-secondary); cursor: pointer; font-weight: 600; font-size: 15px; margin-bottom: 20px; }

        /* ÌåùÏóÖ */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(8px); }
        .popup { padding: 30px; width: 90%; max-width: 340px; text-align: center; transform: scale(0.95); opacity: 0; transition: all 0.2s ease; }
        .overlay.show .popup { transform: scale(1); opacity: 1; }
        .popup input { width: 100%; margin: 15px 0; }
        .btn-cancel, .btn-delete, .btn-save-key { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; }
        .btn-cancel { background: rgba(0,0,0,0.05); color: var(--text-primary); }
        .btn-delete { background: #ef4444; color: white; }
        .btn-save-key { background: var(--accent-color); color: white; width: 100%; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <a href="#" class="logo">binion</a>
            <div class="header-actions">
                <div id="sync-badge" class="icon-btn" style="border-radius:20px; width:auto; padding:0 12px; font-size:12px; gap:6px;">
                    <div style="width:8px; height:8px; background:var(--sync-color); border-radius:50%;" id="sync-dot"></div>
                    <span id="sync-text">Ïó∞Í≤∞</span>
                </div>
                <button class="icon-btn" onclick="openKeyPopup()" title="AI ÏÑ§Ï†ï">
                    <span class="material-icons-round">settings</span>
                </button>
                <button class="theme-toggle-btn" onclick="toggleTheme()">
                    <span class="toggle-indicator"></span>
                </button>
            </div>
        </div>

        <div class="search-box-container">
            <div class="search-box">
                <input type="text" id="inp-search" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•">
                <span class="material-icons-round search-icon">search</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setSort('time')" id="btn-recent">ÏµúÍ∑º Ìï≠Î™©</button>
            <button class="tab-btn" onclick="setSort('category')" id="btn-category">Ïπ¥ÌÖåÍ≥†Î¶¨</button>
        </div>

        <div class="input-card glass-panel">
            <div class="input-row">
                <div class="custom-select-wrapper">
                    <div class="custom-select-trigger" id="category-trigger">
                        <span id="selected-value">AI</span>
                        <span class="material-icons-round">expand_more</span>
                    </div>
                    <div class="custom-options" id="category-options">
                        <div class="custom-option selected" data-value="AI">AI</div>
                        <div class="custom-option" data-value="Ï∞ΩÏóÖ">Ï∞ΩÏóÖ</div>
                        <div class="custom-option" data-value="Ï†ïÎ≥¥">Ï†ïÎ≥¥</div>
                        <div class="custom-option" data-value="ÏùºÏÉÅ">ÏùºÏÉÅ</div>
                        <div class="custom-option" data-value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</div>
                    </div>
                </div>
                <input type="hidden" id="inp-category" value="AI">
                <input type="text" id="inp-url" placeholder="URL Ï£ºÏÜå">
                <button class="btn-ai" onclick="analyzeContent()" title="AIÎ°ú ÏûêÎèô Î∂ÑÏÑù">
                    <span class="material-icons-round">auto_awesome</span>
                </button>
            </div>
            <input type="text" id="inp-memo" placeholder="Í∞ÑÎã®Ìïú Î©îÎ™® (AIÍ∞Ä ÏûêÎèôÏúºÎ°ú Ï±ÑÏõåÏ§çÎãàÎã§)">
            <button class="btn-add" onclick="addItem()">Ïä§ÌÅ¨Îû© Ï†ÄÏû•</button>
        </div>

        <div id="list-container"></div>
    </div>

    <div id="delete-popup" class="overlay">
        <div class="popup glass-panel">
            <h3>ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?</h3>
            <div style="display:flex; justify-content:center; gap:15px; margin-top:20px;">
                <button class="btn-cancel" onclick="closePopup('delete-popup')">Ï∑®ÏÜå</button>
                <button class="btn-delete" id="confirm-delete-btn">ÏÇ≠Ï†ú</button>
            </div>
        </div>
    </div>

    <div id="key-popup" class="overlay">
        <div class="popup glass-panel">
            <h3>üîë Gemini API ÏÑ§Ï†ï</h3>
            <p style="font-size:13px; color:var(--text-secondary); margin-bottom:10px;">
                Î∞úÍ∏âÎ∞õÏùÄ ÌÇ§Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.<br>ÌÇ§Îäî Ïò§ÏßÅ Ïù¥ Í∏∞Í∏∞ÏóêÎßå Ï†ÄÏû•Îê©ÎãàÎã§.
            </p>
            <input type="password" id="inp-api-key" placeholder="AIza..." style="text-align:center;">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-cancel" onclick="closePopup('key-popup')" style="flex:1;">Îã´Í∏∞</button>
                <button class="btn-save-key" onclick="saveApiKey()" style="flex:1;">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js'); }

        const firebaseConfig = {
            apiKey: "AIzaSyAVL2RCzMSboPTJXsfyYkaMjnKz487vuFE",
            authDomain: "binion-6bc32.firebaseapp.com",
            projectId: "binion-6bc32",
            storageBucket: "binion-6bc32.firebasestorage.app",
            messagingSenderId: "389094912030",
            appId: "1:389094912030:web:ea2c93e15c143f84a2fe0f",
            measurementId: "G-RBBVPDB1E0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "notion_data", "scrapbook");
        
        let myData = [];
        let currentSort = 'time';
        let activeFolder = null;
        let searchTerm = '';

        const syncDot = document.getElementById('sync-dot');
        const syncText = document.getElementById('sync-text');
        function setSync(status) {
            if(status==='ok') { syncDot.style.background='var(--sync-active)'; syncText.textContent='ÏôÑÎ£å'; }
            else if(status==='loading') { syncDot.style.background='transparent'; syncDot.style.border='2px solid var(--sync-active)'; syncText.textContent='Ï†ÄÏû•Ï§ë'; }
            else { syncDot.style.background='var(--sync-color)'; syncText.textContent='ÎåÄÍ∏∞'; }
        }

        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                myData = docSnap.data().items || [];
                renderList();
                setSync('ok');
            } else {
                setDoc(docRef, { items: [] });
                myData = [];
                setSync('ok');
            }
        });

        // ----------------------------------------------------
        // [AI Logic] ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÌÇ§ ÏÇ¨Ïö©
        // ----------------------------------------------------
        window.analyzeContent = async function() {
            // Ï†ÄÏû•Îêú ÌÇ§Î•º Í∞ÄÏ†∏ÏòµÎãàÎã§ (ÏΩîÎìúÍ∞Ä ÏïÑÎãå Î∏åÎùºÏö∞Ï†Ä Ï†ÄÏû•ÏÜåÏóêÏÑú!)
            const apiKey = localStorage.getItem('gemini_key');
            
            // ÌÇ§Í∞Ä ÏóÜÏúºÎ©¥ ÏÑ§Ï†ïÏ∞ΩÏùÑ ÎùÑÏõÅÎãàÎã§
            if (!apiKey) { 
                alert("Î®ºÏ†Ä Ïö∞Ï∏° ÏÉÅÎã® ÏÑ§Ï†ï(‚öôÔ∏è)ÏóêÏÑú API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!"); 
                openKeyPopup(); 
                return; 
            }

            const urlInput = document.getElementById('inp-url').value;
            const memoInput = document.getElementById('inp-memo').value;
            const content = urlInput + " " + memoInput;

            if (!content.trim()) { alert("Î∂ÑÏÑùÌï† URLÏù¥ÎÇò ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§."); return; }

            const btn = document.querySelector('.btn-ai');
            btn.classList.add('loading');

            const prompt = `
                Îã§Ïùå ÌÖçÏä§Ìä∏Î•º Î∂ÑÏÑùÌï¥ÏÑú JSON ÌòïÏãùÏúºÎ°ú ÎãµÌï¥Ï§ò.
                ÌÖçÏä§Ìä∏: "${content}"
                
                ÏöîÍµ¨ÏÇ¨Ìï≠:
                1. category: [AI, Ï∞ΩÏóÖ, Ï†ïÎ≥¥, ÏùºÏÉÅ, Í∏∞ÌÉÄ] Ï§ë ÌïòÎÇòÎ•º ÏÑ†ÌÉùÌï¥.
                2. summary: ÎÇ¥Ïö©ÏùÑ Ìïú Î¨∏Ïû•ÏúºÎ°ú ÌïµÏã¨Îßå ÏöîÏïΩÌï¥ (ÌïúÍµ≠Ïñ¥Î°ú).
                3. ÌòïÏãùÏùÄ Ïò§ÏßÅ JSONÎßå Î∞òÌôòÌï¥: {"category": "...", "summary": "..."}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                if (data.error) {
                    console.error(data.error);
                    alert("AI Ïò§Î•ò: " + data.error.message + "\nÌÇ§Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }

                const rawText = data.candidates[0].content.parts[0].text;
                const jsonStr = rawText.replace(/```json|```/g, '').trim();
                const result = JSON.parse(jsonStr);

                if (result.category) {
                    document.getElementById('inp-category').value = result.category;
                    document.getElementById('selected-value').textContent = result.category;
                    document.querySelectorAll('.custom-option').forEach(opt => {
                        opt.classList.remove('selected');
                        if(opt.dataset.value === result.category) opt.classList.add('selected');
                    });
                }
                if (result.summary) {
                    document.getElementById('inp-memo').value = result.summary;
                }

            } catch (e) {
                console.error(e);
                alert("AI Ïó∞Í≤∞ Ïã§Ìå®. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.");
            } finally {
                btn.classList.remove('loading');
            }
        };

        // ----------------------------------------------------
        // [Key Management] ÌÇ§ Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ Í∏∞Îä•
        // ----------------------------------------------------
        window.openKeyPopup = function() {
            document.getElementById('key-popup').classList.add('show');
            document.getElementById('key-popup').style.display = 'flex';
            document.getElementById('inp-api-key').value = localStorage.getItem('gemini_key') || '';
        };
        window.saveApiKey = function() {
            const key = document.getElementById('inp-api-key').value.trim();
            if(key) {
                localStorage.setItem('gemini_key', key);
                alert("ÌÇ§Í∞Ä ÏïàÏ†ÑÌïòÍ≤å Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!");
                closePopup('key-popup');
            }
        };

        window.closePopup = function(id) { 
            document.getElementById(id).classList.remove('show'); 
            setTimeout(()=>document.getElementById(id).style.display='none', 200); 
        };

        window.addItem = async function() {
            const category = document.getElementById('inp-category').value;
            let rawUrlInput = document.getElementById('inp-url').value;
            let memoInput = document.getElementById('inp-memo').value;
            
            if (!rawUrlInput && !memoInput) { alert("ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."); return; }

            const urlRegex = /(https?:\/\/[^\s]+)/;
            const match = rawUrlInput.match(urlRegex);
            let finalUrl = rawUrlInput; 
            let finalMemo = memoInput;

            if (match) {
                finalUrl = match[0];
                if (!finalMemo) {
                    let extracted = rawUrlInput.replace(finalUrl, '').replace(/- YouTube$|- Instagram$/g, '').trim();
                    if (extracted) finalMemo = extracted; 
                }
            } else {
                if(!finalMemo && rawUrlInput) { finalMemo = rawUrlInput; finalUrl = ""; }
            }

            const now = new Date();
            const dateStr = `${now.getFullYear()}. ${now.getMonth()+1}. ${now.getDate()}`;
            const newItem = { id: Date.now(), timestamp: Date.now(), category, url: finalUrl, memo: finalMemo, date: dateStr };

            setSync('loading');
            try {
                await updateDoc(docRef, { items: arrayUnion(newItem) });
                document.getElementById('inp-url').value = '';
                document.getElementById('inp-memo').value = '';
                setSync('ok');
            } catch (e) { console.error(e); setSync('error'); }
        };

        window.renderList = function() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            let filteredList = myData.filter(item => (item.memo+item.url+item.category).toLowerCase().includes(searchTerm));
            
            if (searchTerm) { renderItems(filteredList, container); return; }

            if (currentSort === 'time') {
                activeFolder = null;
                filteredList.sort((a, b) => b.timestamp - a.timestamp);
                renderItems(filteredList, container);
            } else if (currentSort === 'category') {
                if (activeFolder) {
                    const backBtn = document.createElement('button');
                    backBtn.className = 'btn-back';
                    backBtn.innerHTML = `<span class="material-icons-round">arrow_back_ios_new</span> ${activeFolder}`;
                    backBtn.onclick = () => { activeFolder = null; renderList(); };
                    container.appendChild(backBtn);
                    const items = filteredList.filter(item => item.category === activeFolder).sort((a,b)=>b.timestamp-a.timestamp);
                    renderItems(items, container);
                } else {
                    const grid = document.createElement('div'); grid.className = 'folder-grid';
                    ['AI','Ï∞ΩÏóÖ','Ï†ïÎ≥¥','ÏùºÏÉÅ','Í∏∞ÌÉÄ'].forEach(cat => {
                        const cnt = filteredList.filter(i => i.category === cat).length;
                        const el = document.createElement('div'); el.className = 'folder-item glass-panel';
                        el.innerHTML = `<span class="material-icons-round folder-icon">folder</span><div class="folder-name">${cat}</div><div class="folder-count">${cnt}Í∞ú</div>`;
                        el.onclick = () => { activeFolder = cat; renderList(); };
                        grid.appendChild(el);
                    });
                    container.appendChild(grid);
                }
            }
        };

        function renderItems(list, container) {
            const wrapper = document.createElement('div'); wrapper.className = 'scrap-list';
            if(list.length === 0) wrapper.innerHTML = `<div style="text-align:center; opacity:0.6; padding:40px;">ÎπÑÏñ¥ÏûàÏùå</div>`;
            list.forEach(item => {
                const el = document.createElement('div'); el.className = 'card glass-panel';
                let cls = 'cat-etc';
                if(item.category==='AI') cls='cat-ai'; else if(item.category==='Ï∞ΩÏóÖ') cls='cat-startup'; else if(item.category==='Ï†ïÎ≥¥') cls='cat-info'; else if(item.category==='ÏùºÏÉÅ') cls='cat-daily';
                el.innerHTML = `<div class="card-header"><span class="category-badge ${cls}">${item.category}</span><span class="card-date">${item.date}</span></div><div class="card-memo">${item.memo}</div><a href="${item.url}" target="_blank" class="card-url">${item.url}</a>`;
                let timer;
                el.onmousedown=el.ontouchstart = () => { timer = setTimeout(() => openDeletePopup(item), 800); };
                el.onmouseup=el.ontouchend = () => clearTimeout(timer);
                wrapper.appendChild(el);
            });
            container.appendChild(wrapper);
        }

        let itemToDelete = null;
        window.openDeletePopup = function(item) { itemToDelete = item; document.getElementById('delete-popup').classList.add('show'); document.getElementById('delete-popup').style.display='flex'; };
        document.getElementById('confirm-delete-btn').onclick = async function() {
            if(itemToDelete) {
                const newData = myData.filter(i => i.id !== itemToDelete.id);
                await updateDoc(docRef, { items: newData });
                closePopup('delete-popup');
            }
        };

        document.getElementById('inp-search').addEventListener('input', (e) => { searchTerm = e.target.value.toLowerCase(); renderList(); });
        window.setSort = function(type) { currentSort = type; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); if(type==='time') document.getElementById('btn-recent').classList.add('active'); else document.getElementById('btn-category').classList.add('active'); renderList(); };
        window.toggleTheme = function() { 
            const n = document.body.getAttribute('data-theme')==='dark'?'light':'dark';
            document.body.setAttribute('data-theme', n); localStorage.setItem('theme', n);
        };
        
        const trg = document.getElementById('category-trigger'), opts = document.getElementById('category-options');
        trg.onclick = (e) => { e.stopPropagation(); opts.classList.toggle('open'); };
        document.querySelectorAll('.custom-option').forEach(o => {
            o.onclick = () => {
                const v = o.dataset.value;
                document.getElementById('selected-value').textContent = v;
                document.getElementById('inp-category').value = v;
                document.querySelectorAll('.custom-option').forEach(i=>i.classList.remove('selected'));
                o.classList.add('selected'); opts.classList.remove('open');
            };
        });
        document.onclick = (e) => { if(!trg.contains(e.target) && !opts.contains(e.target)) opts.classList.remove('open'); };
        
        document.addEventListener('DOMContentLoaded', () => {
            const p = new URL(window.location.href);
            const t = p.searchParams.get('text'), u = p.searchParams.get('url'), ti = p.searchParams.get('title');
            if(u) document.getElementById('inp-url').value = u;
            else if(t && t.startsWith('http')) document.getElementById('inp-url').value = t;
            else if(t) document.getElementById('inp-memo').value = t;
            if(ti) { const c = document.getElementById('inp-memo').value; document.getElementById('inp-memo').value = c ? ti+" - "+c : ti; }
            document.body.setAttribute('data-theme', localStorage.getItem('theme')||'light');
        });
    </script>
</body>
</html>
