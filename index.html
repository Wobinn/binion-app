<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Binion Scrapbook</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        :root {
            --font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            --bg-image: radial-gradient(circle at 50% 0%, rgba(124, 111, 216, 0.12) 0%, transparent 70%), linear-gradient(180deg, #fcfdff 0%, #f3f4f6 100%);
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 10px 30px rgba(0, 0, 0, 0.06), 0 4px 6px rgba(0, 0, 0, 0.02), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            --glass-blur: blur(15px) saturate(120%);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-color: #6366f1;
            --accent-gradient: linear-gradient(135deg, #6366f1, #818cf8);
            --folder-color: #818cf8;
            --logo-gradient: linear-gradient(to right, #6366f1, #a5b4fc);
            --toggle-bg: rgba(200, 200, 200, 0.2);
            --toggle-indicator: #ffffff;
            --sync-color: #9ca3af;
            --sync-active: #6366f1;
            --dropdown-hover: rgba(99, 102, 241, 0.08);
            --splash-bg: #fcfdff;
        }

        [data-theme="dark"] {
            --bg-image: radial-gradient(circle at 50% -20%, rgba(99, 102, 241, 0.15) 0%, transparent 60%), linear-gradient(180deg, #0f1117 0%, #050505 100%);
            --glass-bg: rgba(20, 22, 30, 0.7); 
            --glass-border: rgba(255, 255, 255, 0.1); 
            --glass-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), 0 8px 16px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            --glass-blur: blur(20px) saturate(140%);
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --accent-color: #818cf8;
            --accent-gradient: linear-gradient(135deg, #818cf8, #6366f1);
            --folder-color: #6366f1;
            --logo-gradient: linear-gradient(to right, #818cf8, #c7d2fe);
            --toggle-bg: rgba(255, 255, 255, 0.1);
            --toggle-indicator: #818cf8;
            --sync-color: #4b5563;
            --sync-active: #818cf8;
            --dropdown-hover: rgba(255, 255, 255, 0.1);
            --splash-bg: #0f1117;
        }

        * { -webkit-tap-highlight-color: transparent; outline: none; }

        /* 스플래시 화면 */
        #custom-splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--splash-bg); 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10000; transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        #custom-splash.hidden { opacity: 0; visibility: hidden; }
        .splash-icon {
            width: 120px; height: 120px; margin-bottom: 20px;
            filter: drop-shadow(0 10px 20px rgba(99, 102, 241, 0.2)); 
            border-radius: 24px;
        }
        .splash-text {
            font-size: 32px; font-weight: 800; letter-spacing: -1px;
            background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .glass-panel {
            background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 24px;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s, background 0.3s;
        }
        body { margin: 0; background-image: var(--bg-image); background-attachment: fixed; background-size: cover; color: var(--text-primary); font-family: var(--font-family); transition: background 0.5s ease, color 0.5s ease; padding-bottom: 100px; line-height: 1.6; min-height: 100vh; overflow-x: hidden; }
        .container { max-width: 860px; margin: 0 auto; padding: 40px 25px; }
        .header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 40px; gap: 15px; }
        .logo { font-size: 38px; font-weight: 800; background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; letter-spacing: -1.5px; }

        .header-actions { display: flex; align-items: center; gap: 12px; }
        
        .icon-btn {
            background: var(--toggle-bg); border: 1px solid var(--glass-border); border-radius: 50%; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            color: var(--sync-active); 
            transition: all 0.3s;
        }
        .icon-btn.syncing { color: var(--sync-color); transform: rotate(180deg); opacity: 0.7; }
        .icon-btn:hover { background: var(--glass-bg); transform: scale(1.1); }
        
        .theme-toggle-btn {
            background: var(--toggle-bg); border: 1px solid var(--glass-border); border-radius: 30px; cursor: pointer;
            display: flex; align-items: center; padding: 4px; position: relative; width: 64px; height: 34px; backdrop-filter: blur(5px);
        }
        .toggle-indicator {
            width: 24px; height: 24px; border-radius: 50%; background: var(--toggle-indicator);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: absolute; left: 4px;
        }
        body[data-theme="dark"] .toggle-indicator { transform: translateX(30px); }
        
        .main-ui { transition: opacity 0.3s; }
        
        .search-box-container { margin-bottom: 40px; display: flex; justify-content: center; }
        .search-box {
            display: flex; align-items: center; width: 100%; max-width: 550px; padding: 12px 24px; border-radius: 40px;
            background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); transition: all 0.3s;
        }
        .search-box:focus-within { border-color: var(--accent-color); transform: translateY(-2px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .search-box input { border: none; background: transparent; padding: 4px; font-size: 16px; flex: 1; outline: none; color: var(--text-primary); font-family: var(--font-family); }
        .search-icon { color: var(--text-secondary); font-size: 24px; opacity: 0.7; margin-left: 10px; display: flex; align-items: center; }

        .tabs { display: flex; gap: 12px; margin-bottom: 40px; justify-content: center; }
        .tab-btn { background: transparent; border: 1px solid transparent; padding: 10px 24px; border-radius: 30px; color: var(--text-secondary); cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.3s; }
        .tab-btn.active { background: var(--accent-gradient); color: #ffffff; box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); }

        .input-card { padding: 35px; margin-bottom: 50px; display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 50; }
        .input-row { display: flex; gap: 12px; align-items: center; }
        
        /* 공유 모드 UI */
        #share-mode-ui {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-image); z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box;
        }
        .share-card { width: 100%; max-width: 360px; padding: 40px; text-align: center; display: flex; flex-direction: column; gap: 30px; }
        .share-title { font-size: 28px; font-weight: 800; margin: 0; background: var(--logo-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .share-question { font-size: 17px; font-weight: 600; color: var(--text-primary); margin: 0; opacity: 0.9; }
        .share-preview { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; background: rgba(0,0,0,0.03); padding: 10px 14px; border-radius: 12px; }

        .custom-select-wrapper { position: relative; width: 35%; min-width: 100px; font-family: var(--font-family); }
        .custom-select-wrapper.full-width { width: 100%; }
        
        .custom-select-trigger {
            display: flex; justify-content: space-between; align-items: center; padding: 16px 20px;
            border: 1px solid var(--glass-border); border-radius: 16px; font-size: 15px; background: rgba(0, 0, 0, 0.03); color: var(--text-primary); cursor: pointer; transition: all 0.3s; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .custom-select-trigger { background: rgba(255, 255, 255, 0.05); }
        
        .custom-options {
            position: absolute; top: 110%; left: 0; right: 0; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s; z-index: 100; overflow: hidden; text-align: left;
            max-height: 220px; overflow-y: auto; 
        }
        .custom-options.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-option { padding: 16px 20px; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.2s; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .custom-option:hover { background: var(--dropdown-hover); color: var(--accent-color); padding-left: 25px; }
        .custom-option.selected { background: var(--accent-gradient); color: white; }

        input[type="text"] {
            padding: 16px 20px; border: 1px solid var(--glass-border); border-radius: 16px; font-size: 15px; font-family: var(--font-family); box-sizing: border-box; transition: all 0.3s; background: rgba(0, 0, 0, 0.03); color: var(--text-primary); flex: 1;
        }
        [data-theme="dark"] input[type="text"] { background: rgba(255, 255, 255, 0.05); }
        input:focus { outline: none; border-color: var(--accent-color); background: transparent; }
        
        .btn-ai {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); color: #fff; border: none; width: 54px; height: 54px; border-radius: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 4px 15px rgba(142, 197, 252, 0.4);
            flex-shrink: 0; 
        }
        .btn-ai:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(142, 197, 252, 0.6); }
        .btn-ai.loading { animation: pulse-ai 1.5s infinite; opacity: 0.8; pointer-events: none; }
        @keyframes pulse-ai { 0% { transform: scale(0.95); } 50% { transform: scale(1.05); } 100% { transform: scale(0.95); } }

        .btn-add {
            background: var(--accent-gradient); color: white; border: none; padding: 18px; border-radius: 16px; font-weight: 700; cursor: pointer; font-size: 16px; margin-top: 10px; transition: all 0.3s; box-shadow: 0 8px 20px rgba(99, 102, 241, 0.25);
        }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(99, 102, 241, 0.4); }
        .btn-add.update-mode { background: linear-gradient(135deg, #10b981, #34d399); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.25); }

        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; margin-top: 30px; }
        .folder-item { padding: 30px 20px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .folder-icon { font-size: 48px; color: var(--folder-color); margin-bottom: 15px; opacity: 0.9; }
        .folder-name { font-size: 15px; font-weight: 700; }
        .folder-count { font-size: 12px; color: var(--text-secondary); margin-top: 5px; opacity: 0.8; }
        
        .scrap-list { display: flex; flex-direction: column; gap: 20px; width:100%; }
        
        /* [핵심] 카드 스타일 재정비 (회색 박스 제거 & 터치 효과) */
        .card { 
            /* 여백 줄이고 깔끔하게 */
            padding: 22px 25px; 
            display: flex; flex-direction: column; gap: 10px; 
            transition: all 0.2s ease; /* 빠른 반응 */
            background: var(--glass-bg); 
            backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border); 
            width: 100%; box-sizing: border-box;
            border-radius: 24px;
            position: relative;
            user-select: none; /* 텍스트 선택 방지 */
        }
        
        /* [수정] 터치 시 눌림 효과 + 배경 페이드 */
        .card:active { 
            transform: scale(0.97); /* 살짝 꾹 눌림 */
            background: rgba(99, 102, 241, 0.08); /* 연한 보라색 페이드 */
            border-color: var(--accent-color);
        }

        /* [NEW] 점 3개 메뉴 버튼 스타일 */
        .card-menu-btn {
            position: absolute; top: 15px; right: 15px;
            background: transparent; border: none;
            color: var(--text-secondary); padding: 8px;
            cursor: pointer; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 10; /* 카드 내용보다 위에 */
        }
        .card-menu-btn:hover, .card-menu-btn:active { background: rgba(0,0,0,0.05); color: var(--text-primary); }

        .card-header { display: flex; justify-content: space-between; align-items: center; padding-right: 30px; /* 메뉴 버튼 공간 확보 */ }
        .category-badge { font-size: 11px; padding: 6px 10px; border-radius: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .cat-ai { background: rgba(99, 102, 241, 0.1); color: #6366f1; }
        .cat-startup { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .cat-info { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .cat-daily { background: rgba(236, 72, 153, 0.1); color: #ec4899; }
        .cat-etc { background: rgba(107, 114, 128, 0.1); color: #6b7280; }
        .card-date { font-size: 12px; color: var(--text-secondary); }
        .card-memo { font-size: 16px; font-weight: 700; line-height: 1.4; color: var(--text-primary); pointer-events: none; }
        .card-url { font-size: 13px; color: var(--accent-color); text-decoration: none; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; opacity: 0.8; margin-top: 4px; pointer-events: none; }
        
        .btn-back { display: inline-flex; align-items: center; gap: 8px; background: transparent; border: none; padding: 10px 0; color: var(--text-secondary); cursor: pointer; font-weight: 600; font-size: 15px; margin-bottom: 20px; }

        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(8px); }
        .popup { padding: 30px; width: 90%; max-width: 340px; text-align: center; transform: scale(0.95); opacity: 0; transition: all 0.2s ease; }
        .overlay.show .popup { transform: scale(1); opacity: 1; }
        
        .popup input {
            width: 100%; padding: 14px; border: 1px solid var(--glass-border); border-radius: 12px;
            background: rgba(0, 0, 0, 0.03); text-align: center; margin-bottom: 20px;
            font-size: 15px; box-sizing: border-box; transition: all 0.3s;
        }
        [data-theme="dark"] .popup input { background: rgba(255, 255, 255, 0.05); }
        .popup input:focus { border-color: var(--accent-color); background: transparent; }
        
        .btn-cancel, .btn-delete, .btn-save-key { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 15px; }
        .btn-cancel { background: rgba(0,0,0,0.05); color: var(--text-primary); }
        .btn-delete { background: #ef4444; color: white; }
        .btn-save-key { background: var(--accent-color); color: white; width: 100%; }

        /* [NEW] 액션 선택 팝업 (수정/삭제) */
        .action-btns { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .btn-action-edit { background: var(--accent-gradient); color: white; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; cursor: pointer; }
        .btn-action-delete { background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; cursor: pointer; }

        .toast {
            visibility: hidden; min-width: 250px; background-color: var(--text-primary); color: var(--bg-color);
            text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 10000;
            left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 15px; font-weight: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        @media screen and (max-width: 768px) {
            .container { padding: 20px 15px; }
            .input-card { padding: 25px 20px; }
            .input-row { flex-wrap: wrap; }
            .custom-select-wrapper { width: 100%; margin-bottom: 12px; }
            #inp-url { flex: 1; width: auto; }
            .search-box-container { margin-bottom: 30px; }
            .search-box { padding: 10px 20px; }
        }

    </style>
</head>
<body>
    <div id="custom-splash">
        <img src="icon-512.jpg" alt="Binion Logo" class="splash-icon">
        <div class="splash-text">binion</div>
    </div>

    <div id="share-mode-ui">
        <div class="share-card glass-panel">
            <h1 class="share-title">Binion</h1>
            <p class="share-question">어떤 카테고리인가요?</p>
            <div class="share-preview" id="share-preview-text">URL 로딩 중...</div>
            
            <div class="custom-select-wrapper full-width">
                <div class="custom-select-trigger" id="share-category-trigger">
                    <span id="share-selected-value">터치하여 선택</span>
                    <span class="material-icons-round">expand_more</span>
                </div>
                <div class="custom-options" id="share-category-options">
                    <div class="custom-option" data-value="AI">AI</div>
                    <div class="custom-option" data-value="창업">창업</div>
                    <div class="custom-option" data-value="정보">정보</div>
                    <div class="custom-option" data-value="일상">일상</div>
                    <div class="custom-option" data-value="기타">기타</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container main-ui" id="main-app">
        <div class="header-row">
            <a href="#" class="logo">binion</a>
            <div class="header-actions">
                <button class="icon-btn" onclick="openKeyPopup()" title="AI 설정" id="btn-settings">
                    <span class="material-icons-round">settings</span>
                </button>
                <button class="theme-toggle-btn" onclick="toggleTheme()">
                    <span class="toggle-indicator"></span>
                </button>
            </div>
        </div>

        <div class="search-box-container">
            <div class="search-box">
                <input type="text" id="inp-search" placeholder="검색어 입력">
                <span class="material-icons-round search-icon">search</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setSort('time')" id="btn-recent">최근 항목</button>
            <button class="tab-btn" onclick="setSort('category')" id="btn-category">카테고리</button>
        </div>

        <div class="input-card glass-panel">
            <div class="input-row">
                <div class="custom-select-wrapper">
                    <div class="custom-select-trigger" id="category-trigger">
                        <span id="selected-value">AI</span>
                        <span class="material-icons-round">expand_more</span>
                    </div>
                    <div class="custom-options" id="category-options">
                        <div class="custom-option selected" data-value="AI">AI</div>
                        <div class="custom-option" data-value="창업">창업</div>
                        <div class="custom-option" data-value="정보">정보</div>
                        <div class="custom-option" data-value="일상">일상</div>
                        <div class="custom-option" data-value="기타">기타</div>
                    </div>
                </div>
                <input type="hidden" id="inp-category" value="AI">
                <input type="text" id="inp-url" placeholder="URL 주소">
                <button class="btn-ai" onclick="analyzeContent()" title="AI로 자동 분석">
                    <span class="material-icons-round">auto_awesome</span>
                </button>
            </div>
            <input type="text" id="inp-memo" placeholder="간단한 메모">
            <button class="btn-add" id="btn-submit" onclick="handleItemSubmit()">스크랩 저장</button>
        </div>

        <div id="list-container"></div>
    </div>

    <div id="action-popup" class="overlay">
        <div class="popup glass-panel">
            <h3 style="margin-bottom:20px;">작업 선택</h3>
            <div class="action-btns">
                <button class="btn-action-edit" id="btn-go-edit">수정하기</button>
                <button class="btn-action-delete" id="btn-go-delete">삭제하기</button>
                <button class="btn-cancel" onclick="closePopup('action-popup')" style="margin-top:5px;">취소</button>
            </div>
        </div>
    </div>

    <div id="custom-alert" class="overlay">
        <div class="popup glass-panel">
            <h3 id="alert-title">알림</h3>
            <p id="alert-message" style="margin-bottom:20px; color:var(--text-secondary);">내용</p>
            <button class="btn-save-key" onclick="closeCustomAlert()">확인</button>
        </div>
    </div>

    <div id="delete-popup" class="overlay">
        <div class="popup glass-panel">
            <h3>삭제하시겠습니까?</h3>
            <div style="display:flex; justify-content:center; gap:15px; margin-top:20px;">
                <button class="btn-cancel" onclick="closePopup('delete-popup')">취소</button>
                <button class="btn-delete" id="confirm-delete-btn">삭제</button>
            </div>
        </div>
    </div>

    <div id="key-popup" class="overlay">
        <div class="popup glass-panel">
            <h3 style="margin-bottom:15px;">Gemini API 설정</h3>
            <p style="font-size:14px; color:var(--text-secondary); margin-bottom:20px; line-height:1.5;">
                발급받은 키를 입력하세요.<br>키는 오직 이 기기에만 저장됩니다.
            </p>
            <input type="password" id="inp-api-key" placeholder="AIza..." style="text-align:center;">
            <div style="display:flex; gap:10px;">
                <button class="btn-cancel" onclick="closePopup('key-popup')" style="flex:1;">닫기</button>
                <button class="btn-save-key" onclick="saveApiKey()" style="flex:1;">저장</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">저장되었습니다!</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js'); }

        const firebaseConfig = {
            apiKey: "AIzaSyAVL2RCzMSboPTJXsfyYkaMjnKz487vuFE",
            authDomain: "binion-6bc32.firebaseapp.com",
            projectId: "binion-6bc32",
            storageBucket: "binion-6bc32.firebasestorage.app",
            messagingSenderId: "389094912030",
            appId: "1:389094912030:web:ea2c93e15c143f84a2fe0f",
            measurementId: "G-RBBVPDB1E0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "notion_data", "scrapbook");
        
        let myData = [];
        let currentSort = 'time';
        let activeFolder = null;
        let searchTerm = '';
        let shareUrl = "";
        let shareMemo = "";
        let shareCategory = "";
        let editModeId = null; 
        let currentActionItem = null;

        const settingsBtn = document.getElementById('btn-settings');
        function setSync(status) {
            if(status==='ok') { 
                settingsBtn.classList.remove('syncing'); 
            } else { 
                settingsBtn.classList.add('syncing'); 
            }
        }

        function hideSplash() {
            const splash = document.getElementById('custom-splash');
            if (splash) {
                splash.classList.add('hidden');
                setTimeout(() => { splash.style.display = 'none'; }, 500);
            }
        }
        
        let isFirstLoad = true;
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                myData = docSnap.data().items || [];
                renderList();
                setSync('ok');
            } else {
                setDoc(docRef, { items: [] });
                myData = [];
                setSync('ok');
            }
            if (isFirstLoad) { hideSplash(); isFirstLoad = false; }
        });
        setTimeout(hideSplash, 3000);

        window.showCustomAlert = function(msg, title="알림") {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = msg;
            document.getElementById('custom-alert').classList.add('show');
            document.getElementById('custom-alert').style.display = 'flex';
        }
        window.closeCustomAlert = function() {
            document.getElementById('custom-alert').classList.remove('show');
            setTimeout(() => document.getElementById('custom-alert').style.display = 'none', 200);
        }

        window.analyzeContent = async function() {
            let apiKey = localStorage.getItem('gemini_key');
            if (apiKey) apiKey = apiKey.trim();

            if (!apiKey) {
                showCustomAlert("먼저 우측 상단 설정(⚙️)에서 API 키를 입력해주세요!", "키가 없습니다"); 
                openKeyPopup();
                return; 
            }

            const rawInput = document.getElementById('inp-url').value;
            const currentMemo = document.getElementById('inp-memo').value;
            
            if (!rawInput.trim() && !currentMemo.trim()) {
                showCustomAlert("분석할 내용이 없습니다!", "내용 부족");
                return;
            }

            const urlRegex = /(https?:\/\/[^\s]+)/;
            const match = rawInput.match(urlRegex);
            let cleanUrl = "";
            let contextText = rawInput;

            if (match) {
                cleanUrl = match[0];
                contextText = rawInput.replace(cleanUrl, '').replace(/- YouTube$|- Instagram$/g, '').trim();
            }

            const finalContext = (contextText + " " + currentMemo).trim();
            document.querySelector('.btn-ai').classList.add('loading');

            const prompt = `
                Analyze the following data and return a JSON object.
                Data provided: URL: "${cleanUrl}", Context: "${finalContext}"
                Instructions:
                1. category: Choose one from [AI, 창업, 정보, 일상, 기타].
                2. summary: Create a clean, short title/summary in Korean.
                3. Return ONLY JSON: {"category": "...", "summary": "..."}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-001:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "AI 요청 실패");
                }

                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());

                if (result.category) {
                    document.getElementById('inp-category').value = result.category;
                    document.getElementById('selected-value').textContent = result.category;
                    updateDropdownSelection(result.category);
                }
                
                if (cleanUrl) document.getElementById('inp-url').value = cleanUrl;
                if (result.summary) document.getElementById('inp-memo').value = result.summary;

            } catch (e) { 
                console.error(e);
                showCustomAlert(e.message, "AI 오류");
            } finally {
                document.querySelector('.btn-ai').classList.remove('loading');
            }
        };

        function updateDropdownSelection(val) {
            document.querySelectorAll('.custom-option').forEach(opt => {
                opt.classList.remove('selected');
                if(opt.dataset.value === val) opt.classList.add('selected');
            });
        }

        window.openKeyPopup = function() {
            document.getElementById('key-popup').classList.add('show');
            document.getElementById('key-popup').style.display = 'flex';
            document.getElementById('inp-api-key').value = localStorage.getItem('gemini_key') || '';
        };
        window.saveApiKey = function() {
            let key = document.getElementById('inp-api-key').value;
            if(key) {
                key = key.trim();
                localStorage.setItem('gemini_key', key);
                closePopup('key-popup');
                showCustomAlert("키가 안전하게 저장되었습니다!", "설정 완료");
            }
        };
        window.closePopup = function(id) { document.getElementById(id).classList.remove('show'); setTimeout(()=>document.getElementById(id).style.display='none', 200); };

        const setupDropdown = (triggerId, optionsId, inputId, displayId, isShare) => {
            const trg = document.getElementById(triggerId);
            const opts = document.getElementById(optionsId);
            trg.onclick = (e) => { e.stopPropagation(); opts.classList.toggle('open'); };
            opts.querySelectorAll('.custom-option').forEach(o => {
                o.onclick = () => {
                    const v = o.dataset.value;
                    document.getElementById(displayId).textContent = v;
                    if(isShare) {
                        shareCategory = v;
                        opts.classList.remove('open');
                        saveFromShareMode(); 
                    } else {
                        document.getElementById(inputId).value = v;
                        updateDropdownSelection(v);
                        opts.classList.remove('open');
                    }
                };
            });
            document.addEventListener('click', (e) => { if(!trg.contains(e.target) && !opts.contains(e.target)) opts.classList.remove('open'); });
        };

        setupDropdown('category-trigger', 'category-options', 'inp-category', 'selected-value', false);
        setupDropdown('share-category-trigger', 'share-category-options', null, 'share-selected-value', true);

        window.handleItemSubmit = async function() {
            const category = document.getElementById('inp-category').value;
            let rawUrlInput = document.getElementById('inp-url').value;
            let memoInput = document.getElementById('inp-memo').value;

            if(editModeId) {
                await updateItemInFirebase(editModeId, category, rawUrlInput, memoInput);
                editModeId = null;
                document.getElementById('btn-submit').textContent = "스크랩 저장";
                document.getElementById('btn-submit').classList.remove('update-mode');
            } else {
                await saveToFirebase(category, rawUrlInput, memoInput);
            }
            document.getElementById('inp-url').value = '';
            document.getElementById('inp-memo').value = '';
        };

        window.saveFromShareMode = async function() {
            const cat = shareCategory || "기타"; 
            await saveToFirebase(cat, shareUrl, shareMemo);
            window.close(); 
            setTimeout(() => { exitShareMode(); }, 300);
        };

        async function saveToFirebase(cat, url, memo) {
            if (!url && !memo) return;
            const urlRegex = /(https?:\/\/[^\s]+)/;
            const match = url.match(urlRegex);
            let finalUrl = url; let finalMemo = memo;

            if (match) {
                finalUrl = match[0];
                if (!finalMemo) finalMemo = url.replace(finalUrl, '').replace(/- YouTube$|- Instagram$/g, '').trim();
            } else {
                if(!finalMemo && url) { finalMemo = url; finalUrl = ""; }
            }
            
            // [자동삭제] 제목 앞의 (1) 같은 숫자 제거
            if(finalMemo) finalMemo = finalMemo.replace(/^\(\d+\)\s*/, '');

            const now = new Date();
            const dateStr = `${now.getFullYear()}. ${now.getMonth()+1}. ${now.getDate()}`;
            const newItem = { id: Date.now(), timestamp: Date.now(), category: cat, url: finalUrl, memo: finalMemo, date: dateStr };

            setSync('loading');
            try { await updateDoc(docRef, { items: arrayUnion(newItem) }); setSync('ok'); } 
            catch (e) { console.error(e); setSync('error'); }
        }

        async function updateItemInFirebase(id, cat, url, memo) {
            setSync('loading');
            if(memo) memo = memo.replace(/^\(\d+\)\s*/, ''); 
            try {
                const newData = myData.map(item => {
                    if(item.id === id) {
                        return { ...item, category: cat, url: url, memo: memo };
                    }
                    return item;
                });
                await updateDoc(docRef, { items: newData });
                setSync('ok');
                // 완료 팝업 제거 (조용히 성공)
            } catch (e) { console.error(e); setSync('error'); }
        }

        window.exitShareMode = function() {
            document.getElementById('share-mode-ui').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            shareUrl = ""; shareMemo = ""; shareCategory = "";
            hideSplash();
        }

        // [핵심] 리스트 렌더링 수정: 스와이프 제거, 점 3개 메뉴 추가
        window.renderList = function() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            let filteredList = myData.filter(item => (item.memo+item.url+item.category).toLowerCase().includes(searchTerm));
            if (searchTerm) { renderItems(filteredList, container); return; }
            if (currentSort === 'time') {
                activeFolder = null;
                filteredList.sort((a, b) => b.timestamp - a.timestamp);
                renderItems(filteredList, container);
            } else if (currentSort === 'category') {
                if (activeFolder) {
                    const backBtn = document.createElement('button');
                    backBtn.className = 'btn-back';
                    backBtn.innerHTML = `<span class="material-icons-round">arrow_back_ios_new</span> ${activeFolder}`;
                    backBtn.onclick = () => { activeFolder = null; renderList(); };
                    container.appendChild(backBtn);
                    const items = filteredList.filter(item => item.category === activeFolder).sort((a,b)=>b.timestamp-a.timestamp);
                    renderItems(items, container);
                } else {
                    const grid = document.createElement('div'); grid.className = 'folder-grid';
                    ['AI','창업','정보','일상','기타'].forEach(cat => {
                        const cnt = filteredList.filter(i => i.category === cat).length;
                        const el = document.createElement('div'); el.className = 'folder-item glass-panel';
                        el.innerHTML = `<span class="material-icons-round folder-icon">folder</span><div class="folder-name">${cat}</div><div class="folder-count">${cnt}개</div>`;
                        el.onclick = () => { activeFolder = cat; renderList(); };
                        grid.appendChild(el);
                    });
                    container.appendChild(grid);
                }
            }
        };

        function renderItems(list, container) {
            const wrapper = document.createElement('div'); wrapper.className = 'scrap-list';
            list.forEach(item => {
                const el = document.createElement('div'); el.className = 'card';
                let cls = 'cat-etc';
                if(item.category==='AI') cls='cat-ai'; else if(item.category==='창업') cls='cat-startup'; else if(item.category==='정보') cls='cat-info'; else if(item.category==='일상') cls='cat-daily';
                
                // 점 3개 메뉴 버튼 추가
                const menuBtnHtml = `<button class="card-menu-btn" onclick="openActionPopup(${item.id})"><span class="material-icons-round" style="font-size:20px;">more_vert</span></button>`;
                
                el.innerHTML = `${menuBtnHtml}<div class="card-header"><span class="category-badge ${cls}">${item.category}</span><span class="card-date">${item.date}</span></div><div class="card-memo">${item.memo}</div><a href="${item.url}" target="_blank" class="card-url">${item.url}</a>`;
                
                // 카드 전체 클릭 시 입체감 효과 (CSS :active가 처리하지만, URL 열기 등 필요시 여기서 처리)
                el.onclick = (e) => {
                    // 메뉴 버튼이나 링크가 아닐 때만 반응
                    if(!e.target.closest('.card-menu-btn') && !e.target.closest('a')) {
                        // 필요시 여기에 클릭 동작 추가 (예: 상세 보기)
                    }
                };

                wrapper.appendChild(el);
            });
            container.appendChild(wrapper);
        }

        // [NEW] 액션 팝업 로직
        window.openActionPopup = function(id) {
            currentActionItem = myData.find(i => i.id === id);
            if(currentActionItem) {
                document.getElementById('action-popup').classList.add('show');
                document.getElementById('action-popup').style.display = 'flex';
            }
        };

        document.getElementById('btn-go-edit').onclick = function() {
            closePopup('action-popup');
            if(currentActionItem) triggerEdit(currentActionItem);
        };

        document.getElementById('btn-go-delete').onclick = function() {
            closePopup('action-popup');
            if(currentActionItem) {
                itemToDelete = currentActionItem;
                document.getElementById('delete-popup').classList.add('show');
                document.getElementById('delete-popup').style.display='flex';
            }
        };

        function triggerEdit(item) {
            editModeId = item.id;
            document.getElementById('inp-category').value = item.category;
            document.getElementById('selected-value').textContent = item.category;
            updateDropdownSelection(item.category);
            document.getElementById('inp-url').value = item.url;
            document.getElementById('inp-memo').value = item.memo;
            
            const btn = document.getElementById('btn-submit');
            btn.textContent = "수정 완료";
            btn.classList.add('update-mode');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // 수정 시작 알림 제거 (조용히 모드 전환)
        }

        let itemToDelete = null;
        document.getElementById('confirm-delete-btn').onclick = async function() {
            if(itemToDelete) {
                const newData = myData.filter(i => i.id !== itemToDelete.id);
                await updateDoc(docRef, { items: newData });
                closePopup('delete-popup');
            }
        };

        document.getElementById('inp-search').addEventListener('input', (e) => { searchTerm = e.target.value.toLowerCase(); renderList(); });
        window.setSort = function(type) { currentSort = type; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); if(type==='time') document.getElementById('btn-recent').classList.add('active'); else document.getElementById('btn-category').classList.add('active'); renderList(); };
        window.toggleTheme = function() { 
            const n = document.body.getAttribute('data-theme')==='dark'?'light':'dark';
            document.body.setAttribute('data-theme', n); localStorage.setItem('theme', n);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const p = new URL(window.location.href);
            const t = p.searchParams.get('text'), u = p.searchParams.get('url'), ti = p.searchParams.get('title');
            document.body.setAttribute('data-theme', localStorage.getItem('theme')||'light');

            if (u || (t && t.startsWith('http')) || ti) {
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('share-mode-ui').style.display = 'flex';
                
                shareUrl = u || (t && t.startsWith('http') ? t : "");
                shareMemo = ti || (!u && t ? t : "");
                document.getElementById('share-preview-text').textContent = shareMemo || shareUrl;

                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>
